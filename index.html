<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Homework Control</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    input, button, select {
      margin: 5px 0;
      display: block;
      padding: 5px;
      width: 250px;
    }
    button { cursor: pointer; }
    #output {
      margin-top: 20px;
      white-space: pre-wrap;
      border: 1px solid #ccc;
      padding: 10px;
      max-width: 600px;
    }
  </style>
</head>
<body>

<h1>Homework Control (Test Panel)</h1>

<!-- LOGIN -->
<h2>Login</h2>
<input type="text" id="login" placeholder="Login" />
<input type="password" id="password" placeholder="Password" />
<button onclick="login()">Login</button>

<hr>

<!-- REGISTER -->
<h2>Register</h2>
<input type="text" id="reg_name" placeholder="Name" />
<input type="text" id="reg_surname" placeholder="Surname" />
<input type="text" id="reg_group" placeholder="Group" />
<input type="number" id="reg_age" placeholder="Age" />
<input type="text" id="reg_login" placeholder="Login" />
<input type="password" id="reg_password" placeholder="Password" />
<input type="text" id="reg_level" placeholder="Level" />

<select id="reg_role">
  <option value="student">Student</option>
</select>

<button onclick="register()">Register</button>

<hr>

<!-- ME INFO -->
<h2>My Info</h2>
<button onclick="getMe()">Get My Info</button>

<!-- ALL USERS -->
<h2>All Users (Admin only)</h2>
<button onclick="getAllUsers()">Get All Users</button>

<div id="output"></div>

<hr>

<h2>All Users (Admin only)</h2>

<input type="text" id="searchUser" placeholder="Search (name, login, group)" />

<select id="limit">
  <option value="5">5</option>
  <option value="10" selected>10</option>
  <option value="20">20</option>
</select>

<button onclick="loadUsers()">Search</button>

<div style="margin-top:10px;">
  <button onclick="prevPage()">â¬… Prev</button>
  <span id="pageInfo"></span>
  <button onclick="nextPage()">Next âž¡</button>
</div>


<hr>

<h2>All Submissions (Admin only)</h2>

<select id="adminStatusFilter">
  <option value="">All</option>
  <option value="PENDING">Pending</option>
  <option value="CHECKED">Checked</option>
</select>

<button onclick="getAllSubmissions()">Get All Submissions</button>


<hr>


<h2>Get User Submissions</h2>
<input type="text" id="userId" placeholder="User ID" />
<select id="statusFilter">
  <option value="">All</option>
  <option value="PENDING">Pending</option>
  <option value="CHECKED">Checked</option>
</select>
<button onclick="getUserSubmissions()">Get Submissions</button>
<h2>Review Submission (Admin)</h2>

<input type="text" id="reviewUserId" placeholder="User ID" />
<input type="text" id="reviewSubmissionId" placeholder="Submission ID" />
<input type="number" id="reviewScore" placeholder="Score (0-100)" />
<input type="text" id="reviewDesc" placeholder="Teacher comment" />

<select id="reviewStatus">
  <option value="CHECKED">CHECKED</option>
  <option value="PENDING">PENDING</option>
</select>

<button onclick="reviewSubmission()">Review</button>

<script>
let totalPages = 1;

let page = 0;

/* ================= ADMIN: ALL SUBMISSIONS ================= */
async function getAllSubmissions() {
  if (!accessToken) return showOutput("Login qiling");

  const status = document.getElementById("adminStatusFilter").value;

  try {
    let url = "http://localhost:8080/submissions";
    if (status) {
      url += `?status=${status}`;
    }

    const res = await fetch(url, {
      headers: {
        Authorization: "Bearer " + accessToken
      }
    });

    const data = await res.json();

    if (!res.ok) return showOutput(data);

    showOutput(data);
  } catch (err) {
    showOutput("Get all submissions error");
  }
}

async function loadUsers() {
  if (!accessToken) return showOutput("Login qiling");

  const search = document.getElementById("searchUser").value;
  const size = document.getElementById("limit").value;

  const params = new URLSearchParams({
    page,
    size,
    search
  });

  try {
    const res = await fetch(
      "http://localhost:8080/all?" + params.toString(),
      {
        headers: { Authorization: "Bearer " + accessToken }
      }
    );

    const data = await res.json();

    if (!res.ok) return showOutput(data);

    showOutput(data); // ðŸ”¥ CHUNKI BACKEND FAQAT ARRAY QAYTARYAPTI

  } catch (err) {
    showOutput("Get users error");
  }
}

function nextPage() {
  if (page < totalPages) {
    page++;
    loadUsers();
  }
}

function prevPage() {
  if (page > 1) {
    page--;
    loadUsers();
  }
}
let accessToken = "";

/* ================= HELPERS ================= */
function showOutput(data) {
  document.getElementById("output").innerText =
    typeof data === "string" ? data : JSON.stringify(data, null, 2);
}

/* ================= ROLE SELECT ================= */

async function updateRoleOptions() {
  const roleSelect = document.getElementById("reg_role");
  
  // default: faqat Student va disabled
  roleSelect.innerHTML = '<option value="student">Student</option>';
  roleSelect.disabled = true;

  if (!accessToken) return;

  try {
    const res = await fetch("http://localhost:8080/me", {
      headers: { Authorization: "Bearer " + accessToken }
    });
    if (!res.ok) return;

    const user = await res.json();

    // Agar user admin bo'lsa select ochiladi
    if (user.role === "admin") {
      roleSelect.innerHTML = `
        <option value="student">Student</option>
        <option value="admin">Admin</option>
      `;
      roleSelect.disabled = false;
    }
  } catch (err) {
    console.error("ROLE CHECK ERROR:", err);
  }
}

async function login() {
  try {
    const res = await fetch("http://localhost:8080/login", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        login: document.getElementById("login").value,
        password: document.getElementById("password").value
      })
    });

    const data = await res.json();
    showOutput(data);

    if (res.ok && data.accessToken) {
      accessToken = data.accessToken;
      await updateRoleOptions();
    }
  } catch (err) {
    showOutput("Login error");
  }
}

/* ================= REGISTER ================= */
async function register() {
  const payload = {
    name: document.getElementById("reg_name").value,
    surname: document.getElementById("reg_surname").value,
    group: document.getElementById("reg_group").value,
    age: Number(document.getElementById("reg_age").value),
    login: document.getElementById("reg_login").value,
    password: document.getElementById("reg_password").value,
    level: document.getElementById("reg_level").value,
    role: document.getElementById("reg_role").value
  };

  try {
    const res = await fetch("http://localhost:8080/register", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: accessToken ? "Bearer " + accessToken : ""
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    showOutput(data);
  } catch (err) {
    showOutput("Register error");
  }
}

// Barcha vazifalarni olish
fetch(`/api/submissions/${userId}`, {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(res => res.json())
.then(data => console.log(data));

// Faqat PENDING vazifalarni olish
fetch(`/api/submissions/${userId}?status=PENDING`, {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(res => res.json())
.then(data => console.log(data));

// Faqat CHECKED vazifalarni olish
fetch(`/api/submissions/${userId}?status=CHECKED`, {
  headers: {
    'Authorization': `Bearer ${token}`
  }
})
.then(res => res.json())
.then(data => console.log(data));

/* ================= ME ================= */
async function getMe() {
  if (!accessToken) return showOutput("Login qiling");
  const res = await fetch("http://localhost:8080/me", {
    headers: { Authorization: "Bearer " + accessToken }
  });
  showOutput(await res.json());
}

/* ================= ALL USERS ================= */
async function getAllUsers() {
  if (!accessToken) return showOutput("Login qiling");
  const res = await fetch("http://localhost:8080/all", {
    headers: { Authorization: "Bearer " + accessToken }
  });
  showOutput(await res.json());
}
async function reviewSubmission() {
  if (!accessToken) return showOutput("Login qiling (admin)");

  const userId = document.getElementById("reviewUserId").value;
  const submissionId = document.getElementById("reviewSubmissionId").value;

  const payload = {
    score: Number(document.getElementById("reviewScore").value),
    teacherDescription: document.getElementById("reviewDesc").value,
    status: document.getElementById("reviewStatus").value
  };

  if (!userId || !submissionId)
    return showOutput("User ID va Submission ID kerak!");

  try {
    const res = await fetch(
      `http://localhost:8080/submissions/${userId}/${submissionId}`,
      {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          Authorization: "Bearer " + accessToken
        },
        body: JSON.stringify(payload)
      }
    );

    const data = await res.json();
    showOutput(data);
  } catch (err) {
    showOutput("Review error");
  }
}


/* ================= GET USER SUBMISSIONS ================= */
async function getUserSubmissions() {
  if (!accessToken) return showOutput("Login qiling");
  
  const userId = document.getElementById("userId").value;
  const status = document.getElementById("statusFilter").value;

  if (!userId) return showOutput("User ID kiriting!");
  
  try {
    let url = `http://localhost:8080/submissions/${userId}`;
    if (status) {
      url += `?status=${status}`;
    }
    
    const res = await fetch(url, {
      headers: { Authorization: "Bearer " + accessToken }
    });
    
    const data = await res.json();
    showOutput(data);
  } catch (err) {
    showOutput("Get submissions error");
  }
}
</script>

</body>
</html>